name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        # Note: mapping host port 5432 can sometimes conflict if runner has a Postgres instance.
        # If you hit problems, remove the ports mapping below.
        ports:
          - "5432:5432"
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        options: >-
          --health-cmd="pg_isready -U test -d testdb"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (with pip cache)
        run: |
          python -m pip install --upgrade pip
          pip install --cache-dir ~/.cache/pip -r requirements.txt

      - name: Ensure pg_isready exists (postgres client)
        run: |
          # pg_isready is usually available in the runner, but install if missing
          if ! command -v pg_isready >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y postgresql-client
          fi

      - name: Wait for Postgres
        run: |
          for i in {1..20}; do
            pg_isready -h localhost -p 5432 -U test -d testdb && break
            echo "Postgres not ready yet..."
            sleep 2
          done

      - name: Debug Postgres (print container info & logs)
        if: always()
        run: |
          echo "=== docker ps -a (postgres containers) ==="
          docker ps -a --filter "ancestor=postgres:15" --format "table {{.ID}}\t{{.Image}}\t{{.Status}}\t{{.Names}}"
          CID=$(docker ps -a --filter "ancestor=postgres:15" --format "{{.ID}}" | head -n 1)
          if [ -n "$CID" ]; then
            echo "Container id: $CID"
            echo "=== inspect health ==="
            docker inspect --format='{{json .State.Health}}' $CID || true
            echo "=== last 200 lines of docker logs ==="
            docker logs --tail 200 $CID || true
          else
            echo "No postgres container found by ancestor filter."
            docker ps -a
          fi

      - name: Run tests
        env:
          DATABASE_URL: "postgresql+psycopg2://test:test@localhost:5432/testdb"
        run: pytest -q

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: Build and push image (hw11)
        env:
          IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/hw11:latest
        run: |
          echo "Building image $IMAGE"
          docker build -t $IMAGE .
          docker push $IMAGE
